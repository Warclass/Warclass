// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id         String   @id @default(uuid())
  name       String
  email      String   @unique
  password   String
  username   String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  sessions     sessions[]
  inscriptions inscriptions[]
  invitations  invitations[]
  teacher      teachers?
  characters   characters[]
}

model sessions {
  id         String   @id @default(uuid())
  user_id    String
  token      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model teachers {
  id             String   @id @default(uuid())
  user_id        String   @unique
  internal_id    String?
  institution_id String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user             users              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  institution      institutions?      @relation(fields: [institution_id], references: [id], onDelete: SetNull)
  teachers_courses teachers_courses[]
  quizzes          quizzes[]          // ⭐ NUEVO: Quizzes creados por el profesor
  events           events[]           // ⭐ NUEVO: Eventos custom del profesor
}

model courses {
  id          String   @id @default(uuid())
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  groups           groups[]
  invitations      invitations[]
  inscriptions     inscriptions[]
  teachers_courses teachers_courses[]
  quizzes          quizzes[]          // ⭐ NUEVO: Quizzes del curso
  events           events[]           // ⭐ NUEVO: Eventos custom del curso
  characters       characters[]       // ⭐ NUEVO: Personajes del curso
}

model teachers_courses {
  id         String   @id @default(uuid())
  teacher_id String
  course_id  String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  teacher teachers                 @relation(fields: [teacher_id], references: [id], onDelete: Cascade)
  course  courses                  @relation(fields: [course_id], references: [id], onDelete: Cascade)
  tasks   teachers_courses_tasks[]

  @@unique([teacher_id, course_id])
}

model groups {
  id         String   @id @default(uuid())
  name       String
  course_id  String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  course     courses      @relation(fields: [course_id], references: [id], onDelete: Cascade)
  characters characters[]
  quizzes    quizzes[]
}

model invitations {
  id         String   @id @default(uuid())
  name       String
  code       String   @unique
  used       Boolean  @default(false)
  user_id    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  course_id  String

  user   users?  @relation(fields: [user_id], references: [id], onDelete: SetNull)
  course courses @relation(fields: [course_id], references: [id], onDelete: Cascade)
}

model inscriptions {
  id         String    @id @default(uuid())
  user_id    String
  course_id  String
  is_active  Boolean   @default(true)
  deleted_at DateTime?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  user   users   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  course courses @relation(fields: [course_id], references: [id], onDelete: Cascade)

  @@unique([user_id, course_id])
}

model characters {
  id         String   @id @default(uuid())
  name       String
  user_id    String
  course_id  String   // Relación con el curso (obligatoria)
  group_id   String?  // Relación con el grupo (opcional - asignada por el profesor después)
  class_id   String
  experience Int      @default(0)
  gold       Int      @default(0)
  energy     Int      @default(100)
  health     Int      @default(100)
  appearance Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user            users                  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  course          courses                @relation(fields: [course_id], references: [id], onDelete: Cascade)
  group           groups?                @relation(fields: [group_id], references: [id], onDelete: Cascade)
  class           classes                @relation(fields: [class_id], references: [id])
  abilities       characters_abilities[]
  tasks           characters_tasks[]
  quizzes_history quizzes_history[]
  events_history  events_history[]

  @@unique([user_id, course_id]) // Un usuario solo puede tener un personaje por curso
}

model classes {
  id    String @id @default(uuid())
  name  String
  speed Int

  characters characters[]
}

model abilities {
  id          String   @id @default(uuid())
  name        String
  description String?
  gold        Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  characters_abilities characters_abilities[]
}

model characters_abilities {
  id           String @id @default(uuid())
  character_id String
  ability_id   String

  character characters @relation(fields: [character_id], references: [id], onDelete: Cascade)
  ability   abilities  @relation(fields: [ability_id], references: [id], onDelete: Cascade)

  @@unique([character_id, ability_id])
}

model quizzes {
  id                   String   @id @default(uuid())
  question             String
  answers              String
  correct_answer_index Int
  difficulty           String   @default("medium")
  points               Int      @default(100)
  time_limit           Int      @default(30)
  group_id             String
  course_id            String   // ⭐ NUEVO: Para saber a qué curso pertenece
  teacher_id           String?  // ⭐ NUEVO: Profesor que lo creó (opcional para retrocompatibilidad)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  group           groups            @relation(fields: [group_id], references: [id], onDelete: Cascade)
  course          courses           @relation(fields: [course_id], references: [id], onDelete: Cascade)
  teacher         teachers?         @relation(fields: [teacher_id], references: [id], onDelete: SetNull)
  quizzes_history quizzes_history[]
}

model quizzes_history {
  id              String   @id @default(uuid())
  quiz_id         String
  character_id    String
  is_on_quest     Boolean  @default(false)
  selected_answer Int
  is_correct      Boolean
  points_earned   Int      @default(0)
  time_taken      Int
  answered_at     DateTime @default(now())

  character characters @relation(fields: [character_id], references: [id], onDelete: Cascade)
  quiz      quizzes    @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@unique([quiz_id, character_id])
}

model tasks {
  id          String   @id @default(uuid())
  name        String
  description String?
  experience  Int      @default(0)
  gold        Int      @default(0)
  health      Int      @default(0)
  energy      Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  characters_tasks       characters_tasks[]
  teachers_courses_tasks teachers_courses_tasks[]
}

model characters_tasks {
  id           String    @id @default(uuid())
  character_id String
  task_id      String
  completed_at DateTime  @default(now()) // ⭐ NUEVO: Fecha de completación

  character characters @relation(fields: [character_id], references: [id], onDelete: Cascade)
  task      tasks      @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@unique([character_id, task_id])
}

model teachers_courses_tasks {
  id                String @id @default(uuid())
  teacher_course_id String
  task_id           String

  teacher_course teachers_courses @relation(fields: [teacher_course_id], references: [id], onDelete: Cascade)
  task           tasks            @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@unique([teacher_course_id, task_id])
}

model events {
  id          String   @id @default(uuid())
  name        String
  description String
  type        String   @default("neutral")
  rank        String   @default("D")
  experience  Int      @default(0)
  gold        Int      @default(0)
  health      Int      @default(0)
  energy      Int      @default(0)
  is_active   Boolean  @default(true)
  is_global   Boolean  @default(true)    // ⭐ NUEVO: true = evento del sistema, false = custom del profesor
  course_id   String?                    // ⭐ NUEVO: Para eventos custom por curso (null = global)
  teacher_id  String?                    // ⭐ NUEVO: Profesor que lo creó (null = sistema)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  course         courses?         @relation(fields: [course_id], references: [id], onDelete: Cascade)
  teacher        teachers?        @relation(fields: [teacher_id], references: [id], onDelete: SetNull)
  events_history events_history[]
}

model events_history {
  id           String   @id @default(uuid())
  event_id     String
  character_id String
  applied_at   DateTime @default(now())

  event     events     @relation(fields: [event_id], references: [id], onDelete: Cascade)
  character characters @relation(fields: [character_id], references: [id], onDelete: Cascade)
}

model institutions {
  id           String   @id @default(uuid())
  name         String
  phone_number String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  teachers teachers[]
}

model accesories {
  id             String   @id @default(uuid())
  name           String
  provider       String
  probability_id String
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
}
